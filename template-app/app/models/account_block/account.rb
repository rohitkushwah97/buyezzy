module AccountBlock
  class Account < AccountBlock::ApplicationRecord
    ActiveSupport.run_load_hooks(:account, self)
    self.table_name = :accounts

    include Wisper::Publisher

    has_secure_password
    has_many :intern_user_generic_answers, class_name: "BxBlockSurveys::InternUserGenericAnswer", dependent: :destroy
    has_many :created_reports, class_name: "BxBlockProfile::Report", foreign_key: :created_by_id, dependent: :destroy
    has_many :received_reports, class_name: "BxBlockProfile::Report", foreign_key: :created_for_id, dependent: :destroy
    has_many :comments, class_name: "BxBlockComments::Comment", dependent: :destroy
    has_many :likes, class_name: "BxBlockLike::Like", dependent: :destroy
    has_many :follows, class_name: "BxBlockFavourites::Follow", dependent: :destroy
    validates :email, uniqueness: { case_sensitive: false, message: "The email address is already taken. Please try another." }
    validates_presence_of :email
    validates :email, format: { with: Devise.email_regexp }
    before_create :generate_api_key
    has_one :blacklist_user, class_name: "AccountBlock::BlackListUser", dependent: :destroy
    has_one :notification_setting, class_name: "BxBlockNotifsettings::NotificationSetting", dependent: :destroy
    has_and_belongs_to_many :internships, class_name: "BxBlockNavmenu::Internship", dependent: :destroy
    after_save :set_black_listed_user
    before_save :set_email
    after_update :send_mail, if: :saved_change_to_email?
    after_update :remove_tokens, if: :saved_change_to_activated?
    after_create :generate_notification_setting
    has_many :notifications,  class_name: "BxBlockNotifications::Notification", dependent: :destroy
    has_many :account_internships, class_name: "BxBlockNavmenu::AccountInternship", dependent: :destroy
    has_many :applied_internships, through: :account_internships, source: :internship

    enum status: %i[regular suspended deleted]

    scope :active, -> { where(activated: true) }
    scope :existing_accounts, -> { where(status: ["regular", "suspended"]) }

    PASSWORD_FORMAT = /(?=.*[A-Z])(?=.*[#!@$&*?<>',\[\]}{=\-)(^%`~+.:;_])(?=.*[0-9])(?=.*[a-z]).{8,20}\z/

    validates :password, presence: true, format: {with: PASSWORD_FORMAT, message: "Minimum 8 characters, maximun 20 characters, atleast one capital letter, atleast one number and atleast one special character"}, on: :create
    before_validation :is_valid_password?, on: :update
    before_destroy :remove_follow_associations

    private

    def remove_follow_associations
      BxBlockFavourites::Follow.where('account_id = ? OR follow_id = ?', id, id).destroy_all
    end

    def set_email
      self.email = self.email.downcase
    end

    def generate_notification_setting
      setting = self.build_notification_setting
      setting.save
    end

    def send_mail
      AccountActivationMailer.with(account: self).activation_email.deliver_now if self.update_column(:activated, false)
    end
    
    def remove_tokens
      expire_tokens.clear
    end

    
    def is_valid_password?
      errors.add(:password, "Minimum 8 characters, maximun 20 characters, atleast one capital letter, atleast one number and atleast one special character")  if password.present? && !password.match(PASSWORD_FORMAT)
    end

    def generate_api_key
      loop do
        @token = SecureRandom.base64.tr("+/=", "Qrt")
        break @token unless Account.exists?(unique_auth_id: @token)
      end
      self.unique_auth_id = @token
    end

    def set_black_listed_user
      if is_blacklisted_previously_changed?
        if is_blacklisted
          AccountBlock::BlackListUser.create(account_id: id)
        else
          blacklist_user.destroy
        end
      end
    end
  end
end
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               